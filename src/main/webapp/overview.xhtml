<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:t="http://myfaces.apache.org/tomahawk">

<h:body>
  <ui:composition template="template.xhtml">
    <ui:define name="content">
      <link rel="stylesheet" type="text/css" href="http://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.8.2/css/jquery.dataTables.css"/>
      <script type="text/javascript" charset="utf8" src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.7.1.min.js"></script>
      <script type="text/javascript" charset="utf8" src="http://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.8.2/jquery.dataTables.min.js"></script>
      <script type="text/javascript" src="datatable.sort.js"></script>

      <script type="text/javascript" charset="utf8" >
        $(document).ready(function() {
          $("[id$=databrokers]").dataTable({
            "bFilter": false,
            "bInfo": false,
            "sScrollY": Math.min(400, $("[id$=databrokers]").height()) + "px",
            "bPaginate": false,
            "aoColumnDefs": [
              { "sType": "natural", "aTargets": [0] }
            ]
          });
          $("[id$=datatourneys]").dataTable({
            "bFilter": false,
            "bInfo": false,
            "sScrollY": Math.min(400, $("[id$=datatourneys]").height()) + "px",
            "bPaginate": false,
            "aoColumnDefs": [
              { 'bSortable': false, 'aTargets': [5, 6, 7, 8] },
              { "sType": "natural", "aTargets": [0] }
            ]
          });
          $("[id$=datagames]").dataTable({
            "bFilter": false,
            "bInfo": false,
            "sScrollY": Math.min(400, $("[id$=datagames]").height()) + "px",
            "bPaginate": false,
            "aoColumnDefs": [
              { 'bSortable': false, 'aTargets': [4, 5, 6] },
              { "sType": "natural", "aTargets": [0, 1] }
            ]
          });
        });
      </script>

      <style type="text/css">
        table.dataTable tr.odd {
          background-color: #FFFFFF;
        }
        table.dataTable tr.odd td.sorting_1 {
          background-color: #FFFFFF;
        }
        table.dataTable tr.even td.sorting_1 {
          background-color: #FFFFFF;
        }
      </style>

      <h2>Overview</h2>

      <h:form rendered="#{(user.permissionId le 0) and (actionOverview.brokerList.size() > 0)}" id="formDatabrokers">
        <h3 class="withButton">Registered Brokers</h3><h:commandButton value="Refresh" action="#{actionOverview.refresh}"/>
        <t:dataTable id="databrokers" border="1"
                     style="border:1px solid black;border-collapse:collapse;text-align:center"
                     value="#{actionOverview.brokerList}" var="broker">

          <t:column>
            <f:facet name="header">ID</f:facet>
            <h:outputText value="#{broker.brokerId}" />
          </t:column>

          <t:column>
            <f:facet name="header">Name</f:facet>
            <h:outputLink value="mailto:#{broker.user.contactEmail}" >
              <h:outputText value="#{broker.brokerName}" />
            </h:outputLink>
          </t:column>

          <t:column>
            <f:facet name="header">User</f:facet>
            <h:outputText value="#{broker.user.userName}" />
          </t:column>

          <t:column>
            <f:facet name="header">Registered</f:facet>
            <h:outputText value="#{broker.getRegisteredString()}" />
          </t:column>

          <t:column style="text-align: right">
            <f:facet name="header">Add</f:facet>
            <h:selectOneMenu value="#{broker.selectedTourneyRegister}">
              <f:selectItems value="#{actionOverview.getAvailableTournaments(broker)}" var="t"
                             itemValue="#{t.tournamentId}" itemLabel="#{t.tournamentName}" rendered="{(t.maxBrokers != t.numberRegistered)}"/>
            </h:selectOneMenu>
            <h:commandButton value="register" action="#{actionOverview.register(broker)}" />
          </t:column>

          <t:column style="text-align: right">
            <f:facet name="header">Remove</f:facet>
            <h:selectOneMenu value="#{broker.selectedTourneyUnregister}">
              <f:selectItems value="#{actionOverview.getRegisteredTournaments(broker)}" var="t"
                             itemValue="#{t.tournamentId}" itemLabel="#{t.tournamentName}" rendered="{(t.maxBrokers != t.numberRegistered)}"/>
            </h:selectOneMenu>
            <h:commandButton value="unregister" action="#{actionOverview.unregister(broker)}" />
          </t:column>

          <t:column>
            <f:facet name="header">Logins</f:facet>
            <t:outputText value="#{actionOverview.getLogins(broker.getBrokerId())}"/>
          </t:column>
        </t:dataTable>
        <h:messages for="formDatabrokers" layout=""/>
      </h:form>

      <h:form rendered="#{(user.permissionId le 0) and (actionOverview.notCompleteTournamentList.size() > 0)}">
        <h3 class="withButton">Pending/Running Tournaments</h3><h:commandButton value="Refresh" action="#{actionOverview.refresh}"/>
        <t:dataTable id="datatourneys" border="1"
                     style="border:1px solid black;border-collapse:collapse;text-align:center"
                     value="#{actionOverview.notCompleteTournamentList}" var="t">

          <t:column>
            <f:facet name="header">ID</f:facet>
            <h:outputText value="#{t.tournamentId}" />
          </t:column>

          <t:column>
            <f:facet name="header">Name</f:facet>
            <h:link value="#{t.tournamentName}" outcome="Tournament">
              <f:param name="tournamentId" value="#{t.tournamentId}" />
            </h:link>
          </t:column>

          <t:column>
            <f:facet name="header">Status</f:facet>
            <h:outputText value="#{t.status}" />
            <h:outputText value=" / closed" rendered="#{t.closed}"/>
          </t:column>

          <t:column>
            <f:facet name="header">Type</f:facet>
            <h:outputText value="Multi" rendered="#{t.type == 'MULTI_GAME'}"/>
            <h:outputText value="Single" rendered="#{t.type == 'SINGLE_GAME'}"/>
          </t:column>

          <t:column>
            <f:facet name="header">Start Time</f:facet>
            <h:outputText value="#{t.startTimeUTC()}" />
          </t:column>

          <t:column>
            <f:facet name="header">Reg / Max</f:facet>
            <h:outputText value="#{t.brokerMap.size()} / #{t.maxBrokers}"/>
            <h:outputText value=" : #{t.maxAgents}" rendered="#{t.type == 'MULTI_GAME'}"/>
          </t:column>

          <t:column>
            <f:facet name="header">Games</f:facet>
            <h:outputText value="#{t.size1} (#{t.multiplier1})  #{t.size2} (#{t.multiplier2})  #{t.size3} (#{t.multiplier3})"
                          rendered="#{t.type == 'MULTI_GAME'}"/>
          </t:column>

          <t:column>
            <f:facet name="header">Pom</f:facet>
            <a href="pom.jsp?pomId=#{t.pomId}">
              <h:outputText value="#{t.pomId}" />
            </a>
          </t:column>

          <t:column>
            <f:facet name="header">Actions</f:facet>
            <h:commandButton value="Now" action="#{actionOverview.startNow(t)}"
                             onclick="return confirmAlert('This will start all the games in this tournament now. Proceed?');"
                             rendered="#{!t.isStarted()}"/>
          </t:column>
        </t:dataTable>
      </h:form>

      <h:form rendered="#{(user.permissionId le 0) and (actionOverview.notCompleteGamesList.size() > 0)}" id="gamesForm">
        <h3 class="withButton">Pending/Running Games</h3><h:commandButton value="Refresh" action="#{actionOverview.refresh}"/>
        <t:dataTable id="datagames" border="1"
                     style="border:1px solid black;border-collapse:collapse;text-align:center"
                     value="#{actionOverview.notCompleteGamesList}" var="g">
          <t:column>
            <f:facet name="header">ID</f:facet>
            <h:outputText value="#{g.gameId}" />
          </t:column>

          <t:column>
            <f:facet name="header">Name</f:facet>
            <h:link value="#{g.gameName}" outcome="Game">
              <f:param name="gameId" value="#{g.gameId}" />
            </h:link>
          </t:column>

          <t:column>
            <f:facet name="header">Status</f:facet>
            <h:outputText value="#{g.status}" />
          </t:column>

          <t:column>
            <f:facet name="header">Start Time</f:facet>
            <h:outputText value="#{g.startTimeUTC()}" />
          </t:column>

          <t:column>
            <f:facet name="header">Heartbeat</f:facet>
            <t:outputText value="#{actionOverview.getHeartbeat(g.gameId)}"
                rendered="#{g.isRunning()}" />
          </t:column>

          <t:column style="text-align: left">
            <f:facet name="header">Links</f:facet>
            <h:panelGroup>
              <h:outputLink value="properties.jsp?gameId=#{g.gameId}"
                            target="_blank">Props</h:outputLink>

              <h:outputText value=" | " rendered="#{g.hasBootstrap()}"/>
              <h:outputLink value="serverInterface.jsp?action=boot&amp;gameId=#{g.gameId}"
                            rendered="#{g.hasBootstrap()}"
                            target="_blank">Boot</h:outputLink>

              <h:outputText value=" | " rendered="#{g.isRunning()}"/>
              <h:outputLink value="http://#{g.machine.vizUrl}"
                            rendered="#{g.isRunning()}"
                            target="_blank">Viz</h:outputLink>

              <h:outputText value=" | " rendered="#{g.machine != null}"/>
              <h:outputLink value="#{g.jenkinsMachineUrl()}"
                            rendered="#{g.machine != null}"
                            target="_blank">Jenkins</h:outputLink>
            </h:panelGroup>
          </t:column>

          <t:column>
            <f:facet name="header">Actions</f:facet>
            <h:panelGroup>
              <h:commandButton value="Abort" action="#{actionOverview.abortGame(g)}"
                               onclick="return confirmAlert('Are you sure you want to abort this game?');"
                               rendered="#{g.machine != null and g.isRunning()}" />
              <h:commandButton value="Kill" action="#{actionOverview.killGame(g)}"
                               onclick="return confirmAlert('Are you sure you want to kill this game?');"
                               rendered="#{g.machine != null}" />
              <h:commandButton value="Restart" action="#{actionOverview.restartGame(g)}"
                               rendered="#{g.gameFailed()}" />
            </h:panelGroup>
          </t:column>
        </t:dataTable>

        <h:messages for="gamesForm" />
        <br/>
      </h:form>

      <h:form rendered="#{user.permissionId gt 0}">
        <h3>Insufficient Permissions, redirecting in 10 seconds</h3>
        <meta http-equiv="REFRESH" content="10;url=login.xhtml" />
      </h:form>

    </ui:define>
  </ui:composition>
</h:body>
</html>