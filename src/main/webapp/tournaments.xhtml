<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:t="http://myfaces.apache.org/tomahawk">

<h:body>
  <ui:composition template="template.xhtml">
    <ui:define name="content">

      <h:form rendered="#{user.isAdmin() and actionTournaments.tournamentList.size() > 0}"
              id="runningTournaments">
        <h2>Tournament Manager</h2>

        <h3 class="withButton">Pending/Running Tournaments</h3>
        <h:commandButton value="Refresh"/>
        <t:dataTable id="dataTournaments" border="1"
                     value="#{actionTournaments.tournamentList}" var="c">

          <t:column>
            <f:facet name="header">ID</f:facet>
            <h:outputText value="#{c.tournamentId}"/>
          </t:column>

          <t:column>
            <f:facet name="header">Name</f:facet>
            <h:link value="#{c.tournamentName}" outcome="Tournament">
              <f:param name="tournamentId" value="#{c.tournamentId}"/>
            </h:link>
          </t:column>

          <t:column styleClass="#{actionTournaments.getLevelStyle(c, 0)}">
            <f:facet name="header" >Level 0</f:facet>
            <h:outputText value="#{actionTournaments.getLevelInfo(c).get(0)}"
                          escape="false"/>
          </t:column>

          <t:column styleClass="#{actionTournaments.getLevelStyle(c, 1)}">
            <f:facet name="header">Level 1</f:facet>
            <h:outputText value="#{actionTournaments.getLevelInfo(c).get(1)}"
                          escape="false"/>
          </t:column>

          <t:column styleClass="#{actionTournaments.getLevelStyle(c, 2)}">
            <f:facet name="header">Level 2</f:facet>
            <h:outputText value="#{actionTournaments.getLevelInfo(c).get(2)}"
                          escape="false"/>
          </t:column>

          <t:column styleClass="#{actionTournaments.getLevelStyle(c, 3)}">
            <f:facet name="header">Level 3</f:facet>
            <h:outputText value="#{actionTournaments.getLevelInfo(c).get(3)}"
                          escape="false"/>
          </t:column>

          <t:column>
            <f:facet name="header">Pom</f:facet>
            <a href="pom.jsp?pomId=#{c.pomId}">
              <h:outputText value="#{c.pomId}"/>
            </a>
          </t:column>

          <t:column>
            <f:facet name="header">Status</f:facet>
            <h:outputText value="#{c.state}"/>
          </t:column>

          <t:column styleClass="left">
            <f:facet name="header">Actions</f:facet>
            <h:commandButton value="Close"
                             action="#{actionTournaments.closeTournament(c)}"
                             rendered="#{actionTournaments.closingAllowed(c)}"
                             styleClass="actionButton"/>
            <h:commandButton value="Schedule"
                             action="#{actionTournaments.scheduleTournament(c)}"
                             rendered="#{actionTournaments.schedulingAllowed(c)}"
                             styleClass="actionButton"/>
            <h:commandButton value="Complete"
                             action="#{actionTournaments.completingTournament(c)}"
                             rendered="#{actionTournaments.completingAllowed(c)}"
                             styleClass="actionButton"/>

            <h:commandButton value="Edit"
                             action="#{actionTournaments.loadTournament(c)}"
                             rendered="#{actionTournaments.editingAllowed(c)}"
                             styleClass="actionButton"/>
            <h:commandButton value="Cancel"
                             action="#{actionTournaments.resetValues()}"
                             rendered="#{actionTournaments.tournamentId == c.tournamentId}"
                             styleClass="actionButton"/>
          </t:column>
        </t:dataTable>
        <br/>
        <h:messages for="runningTournaments"/>
      </h:form>

      <h:form rendered="#{user.isAdmin() and (actionTournaments.brokerList.size() > 0)}"
              id="tournamentRegistered">
        <h3 class="withButton">Registered Brokers</h3>
        <h:commandButton value="Refresh"/>
        <t:dataTable id="databrokers" border="1"
                     value="#{actionTournaments.brokerList}" var="broker">

            <t:column>
                <f:facet name="header">ID</f:facet>
                <h:outputText value="#{broker.brokerId}"/>
            </t:column>

            <t:column>
                <f:facet name="header">Name</f:facet>
                <h:outputText value="#{broker.brokerName}"/>
            </t:column>

            <t:column>
                <f:facet name="header">Registered</f:facet>
                <h:outputText value="#{broker.getTournamentsString()}"/>
            </t:column>

            <t:column style="text-align: right">
                <f:facet name="header">Add</f:facet>
                <h:selectOneMenu value="#{broker.registerTournamentId}"
                                 styleClass="smallButton">
                    <f:selectItems
                            value="#{actionTournaments.getAvailableTournaments(broker)}"
                            var="t"
                            itemValue="#{t.tournamentId}"
                            itemLabel="#{t.tournamentName}"
                            rendered="{(t.maxBrokers != t.numberRegistered)}"/>
                </h:selectOneMenu>
                <h:commandButton value="Register" styleClass="smallButton"
                                 action="#{actionTournaments.register(broker)}"/>
            </t:column>

            <t:column style="text-align: right">
                <f:facet name="header">Remove</f:facet>
                <h:selectOneMenu value="#{broker.unregisterTournamentId}"
                                 styleClass="smallButton">
                    <f:selectItems
                            value="#{actionTournaments.getRegisteredTournaments(broker)}"
                            var="t"
                            itemValue="#{t.tournamentId}"
                            itemLabel="#{t.tournamentName}"
                            rendered="{(t.maxBrokers != t.numberRegistered)}"/>
                </h:selectOneMenu>
                <h:commandButton value="Unregister" styleClass="smallButton"
                                 action="#{actionTournaments.unregister(broker)}"/>
            </t:column>
        </t:dataTable>
        <h:messages for="tournamentRegistered" layout=""/>
        <br/>
      </h:form>

      <h:form enctype="multipart/form-data" rendered="#{user.isAdmin()}"
              id="saveTournament">
        <h:panelGroup rendered="#{actionTournaments.tournamentId == -1}">
          <h3>Create Tournament</h3>
        </h:panelGroup>
        <h:panelGroup rendered="#{actionTournaments.tournamentId != -1}">
          <h3>Edit Tournament</h3>
        </h:panelGroup>

        <h:panelGrid columns="2" id="tournamentTable">
          <h:outputText value="Tournament Name"/>
          <h:inputText value="#{actionTournaments.tournamentName}"
                       readonly="#{actionTournaments.disabledArray[0]}"
                       styleClass="input_wide"/>

          <h:outputText value="Select Pom File"/>
          <h:panelGroup>
            <h:selectOneMenu id="poms"
                             disabled="#{actionTournaments.disabledArray[0]}"
                             value="#{actionTournaments.selectedPom}">
              <f:selectItems value="#{actionTournaments.pomList}" var="p"
                             itemValue="#{p.pomId}" itemLabel="#{p.pomName}"/>
            </h:selectOneMenu>
          </h:panelGroup>

          <h:panelGroup/>
          <h:panelGroup><br/></h:panelGroup>

          <ui:repeat value="#{actionTournaments.levels}" var="r">
            <tr>
              <td><h:outputText value="Level #{r.levelNr} name"/></td>
              <td><h:inputText value="#{r.levelName}"
                               disabled="#{actionTournaments.disabledArray[r.levelNr]}"
                               styleClass="input_wide" /></td>
            </tr>
            <tr>
              <td><h:outputText value="Rounds / winners" /></td>
              <td>
                <h:panelGroup>
                  <h:inputText value="#{r.nofRounds}"
                               readonly="#{actionTournaments.disabledArray[r.levelNr]}"
                               styleClass="input_small" />
                  <h:inputText value="#{r.nofWinners}"
                               readonly="#{actionTournaments.disabledArray[r.levelNr]}"
                               styleClass="input_small" />
                </h:panelGroup>
              </td>
            </tr>
            <tr>
              <td><h:outputText value="StartTime UTC"/></td>
              <td>
                <h:panelGroup>
                  <t:inputDate value="#{r.startTime}"
                               readonly="#{actionTournaments.disabledArray[r.levelNr]}"
                               disabled="#{actionTournaments.disabledArray[r.levelNr]}"
                               id="levelStartTime" ampm="false" type="both"/>
                </h:panelGroup>
              </td>
            </tr>

            <tr>
              <td><br/></td>
              <td/>
            </tr>
          </ui:repeat>

          <h:commandButton value="Submit"
                           action="#{actionTournaments.saveTournament()}"/>
        </h:panelGrid>
        <h:inputHidden id="tournamentId"
                       value="#{actionTournaments.tournamentId}"/>
        <br/>
        <h:messages for="saveTournament"/>
      </h:form>

      <h:form rendered="#{!user.isAdmin()}">
        <h3>Insufficient Permissions, redirecting in 10 seconds</h3>
        <meta http-equiv="REFRESH" content="10;url=login.xhtml"/>
      </h:form>
    </ui:define>
  </ui:composition>
</h:body>
</html>